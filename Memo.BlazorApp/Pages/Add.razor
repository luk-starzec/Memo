@page "/add"

@inject IMemosRepo memosRepo
@inject ITokenManager tokenManager;
@inject NavigationManager navigationManager


<div class="add-page__wrapper">

    <Logo class="add-page__logo" />

    <EditForm class="add-page__form" Model="@memo" OnValidSubmit="AddMemo">
        <DataAnnotationsValidator />

        <input type="text" class="add-page__url" value="@memo.Url" placeholder="generated url" readonly />

        <InputOnInput class="add-page__title" placeholder="title"
                      @bind-Value="@memo.Title" ValidationFunction="()=>ValidateField(nameof(memo.Title))" />
        <ValidationMessage For="() => memo.Title" />

        <InputTextArea class="add-page__text" @bind-Value="memo.Text" placeholder="message" />
        <ValidationMessage For="() => memo.Text" />

        <div class="add-page__form-row">

            <label class="add-page__label">
                <InputCheckbox class="add-page__expires-checkbox" @bind-Value="memo.EnabledValidTo" />
                Expires:
            </label>

            <InputDate class="add-page__expires-date" @bind-Value="memo.ValidTo" />

        </div>

        <label class="add-page__label">
            Pin:
            <InputOnInput class="add-page__pin" @bind-Value="memo.Pin" InputType="password" ValidationFunction="()=>ValidateField(nameof(memo.Pin))" />
        </label>
        <ValidationMessage For="() => memo.Pin" />

        <label class="add-page__label">
            Confirm:
            <InputOnInput class="add-page__pin" @bind-Value="memo.ConfirmPin" InputType="password" ValidationFunction="()=>ValidateField(nameof(memo.ConfirmPin))" />
        </label>
        <ValidationMessage For="() => memo.ConfirmPin" />

        <button type="submit" class="add-page__add-button">
            <img src="/assets/add-icon.svg" />
            <span>Add memo</span>
        </button>

    </EditForm>

    <img class="add-page__background-image" src="/assets/add-image.svg" />

</div>

@code {
    MemoNewModel memo = new MemoNewModel();

    bool ValidateField(string field)
    {
        if (field == nameof(memo.Title))
            GenerateUrl();

        var errors = memo.Validate();
        return !errors.Where(r => r.MemberNames.Contains(field)).Any();
    }

    void GenerateUrl()
    {
        memo.Url = Helpers.GetUrl(memo.Title);
        StateHasChanged();
    }

    async Task AddMemo(EditContext editContext)
    {
        if (await memosRepo.CreateMemo(memo))
        {
            var token = tokenManager.CreateToken(memo.Pin);
            navigationManager.NavigateTo($"/view/{memo.Url}/{token}");
        }
        // TODO error handling
    }

}
